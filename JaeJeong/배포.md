# 📍 무중단 배포

- 롤링(Rolling Update) 방식
- 블루 그린(Blue-Green Deployment) 방식
- 카나리(Canary Release) 방식

<br>

💡 Nginx

엔진엑스는 웹 서버, 리버스 프록시, 캐싱, 로드 밸런싱, 미디어 스트리밍 등을 위한 오픈소스 소프트웨어로, 저렴하고 사용법이 간단하기 때문에 대부분의 서비스들이 엔진엑스를 사용하고 있다.

> 리버스 프록시 : 엔진엑스가 외부의 요청을 받아 백엔드 서버로 요청을 전달하는 행위

<br>

## 롤링(Rolling Update) 방식

![image](https://user-images.githubusercontent.com/78673570/188549323-231629fb-5abe-4f8f-92b6-20b272372281.png)

- 사용 중인 인스턴스 내에서 새 버전을 교체하는 가장 기본적인 방식
- 서비스 중인 인스턴스 하나를 로드밸런서에서 라우팅하지 않도록 한 뒤, 새 버전을 적용하여 다시 라우팅하도록

<br>

### 장점

- 구성된 자원을 그대로 유지한 채 무중단 배포가 가능하므로 관리가 편하다.
- 인스턴스마다 차례로 배포를 진행하기 때문에 상황에 따라 손쉽게 롤백이 가능하다.

<br>

### 단점

- 인스턴스가 제한적일 경우에 사용되며, 새 버전을 배포할 때 인스턴스 수가 감소하기 때문에 서비스 처리 용량을 고려해야 한다.
- 배포가 진행되는 동안 구버전과 신버전이 공존하기 때문에 호환성 문제가 발생할 수 있다.

<br>

## 블루 그린(Blue-Green Deployment) 방식

![image](https://user-images.githubusercontent.com/78673570/188549563-7a2321af-905d-452d-a77a-4840af01b7a2.png)

- 블루 = 구버전, 그린 = 신버전
- 운영 환경에서 구 버전과 동일하게 신버전을 배포하고 일제히 전환하여 모든 연결을 신버전으로 전환하는 방식

<br>

### 장점

- 롤링 배포와 마찬가지로 빠른 롤백이 가능하다.
- 구버전과 동일한 환경에서 신버전 인스턴스를 구성하기 때문에 실제 서비스 환경에서 신버전을 미리 테스트할 수 있다.
- 배포가 완료된 후 남아있는 구버전 환경을 다음 배포에 재사용할 수 있다.
- 신버전 배포가 진행되는 동안 서버 과부하가 일어날 확률이 적다.

<br>

### 단점

- 롤링 배포와 비교하여 시스템 자원이 2배 이상 필요해 소규모 프로젝트에 적용하기 어렵다.

  > 따라서 물리적인 서버를 대상을 사용하기에는 비용상 버겁기 때문에 클라우드 환경에서 쉽게 인스턴스를 생성하거나 없앨 수 있는 AWS나 Docker 컨테이너와 같은 가상 환경에서 사용하는 것이 더 좋다.

<br>

## 카나리(Canary Release) 방식

![image](https://user-images.githubusercontent.com/78673570/188550899-a279823c-9152-47d0-a1f9-2e715232d6d3.png)

- 위험을 빠르게 감지할 수 있는 배포 전략
- 신버전의 제공 범위를 늘려가면서 모니터링 및 피드백 과정을 거칠 수 있는 방식

<br>

### 장점

- 블루-그린 배포와 마찬가지로 신버전 배포 전에 실제 운영 환경에서 미리 테스트할 수 있다.
- 단계적인 전환 방식을 통해 부정적 영향을 최소화하고 상황에 따라 트래픽 양을 늘리거나 롤백할 수 있다.

<br>

### 단점

- 롤링 배포와 마찬가지로 구버전과 신버전이 같이 운영되기 때문에 버전 관리가 필요하다.

<br><br>

# 📍 Nginx를 이용한 블루-그린 무중단 배포

AWS EC2 인스턴스의 포트를 2개로 나누어, 블루-그린 방식으로 무중단 배포를 진행한다.

- 엔진엑스는 `80(http)`, `443(https)` 포트를 할당한다.
- 스프링 부트 1은 `8081` 포트로 실행한다.
- 스프링 부트 2는 `8002` 포트로 실행한다.

<br>

## 스프링 부트 버전 1.0.0 배포

![image](https://user-images.githubusercontent.com/78673570/188551504-6302e1a2-88c9-40f8-825a-2b24fc8dce55.png)

1. 사용자가 서비스에 접속한다. (80포트 or 443 포트)
2. 엔진엑스는 사용자의 요청을 받아 현재 연결된 `스프링 부트 1(= 8081)`에 요청을 전달한다.
3. 스프링 부트 2는 엔진엑스와 연결된 상태가 아니므로 요청을 받지 못한다.

<br>

## 스프링 부트 버전 1.0.1 배포

![image](https://user-images.githubusercontent.com/78673570/188551702-b6acf6d1-b4e1-4a87-bfc6-dfeca65648a9.png)

1. 새로운 버전 1.0.1은 엔진엑스와 연결되지 않은 `스프링 부트 2(= 8082)`로 배포한다.
2. 배포가 끝나고 정상적으로 스프링 부트 2가 구동 중인지 확인한다.
3. 스프링 부트 2가 정상 구동 중이면 `nginx reload` 명령어를 통해 8081에서 8082로 연결을 변경한다.
4. nginx reload는 0.1초 내로 완료되기 때문에 클라이언트는 알아채지 못한다.

<br>

=> 이와 같이 스프링 부트 1, 2로 번갈아가며 연결하여 무중단 배포를 진행한다.
